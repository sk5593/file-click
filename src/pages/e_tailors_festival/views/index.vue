<template>
    <div class="container">
        <article class="content" :class="{'hasAside': state&&config.valid&&(state<4||(state==4&&join))}">
            <header class="header">
                <img class="img-bg-header" :src="IMGPrefix+'/img/e_tailors_festival/bg-header.png'" alt="">
                <div class="bg-title textcenter">
                    <div><img class="img-bg-title" :src="IMGPrefix+'/img/e_tailors_festival/bg-title.png'" alt=""></div>
                    <div class="bg-title-word">
                        <img class="img-bg-title-2" :src="IMGPrefix+'/img/e_tailors_festival/bg-title-2.png'" alt="">
                    </div>
                </div>
            </header>
            <main class="main-coupon">
                <!-- 拆券中 -->
                <div v-if="config.valid&&config.isOpenDateEnd==false">
                    <section v-if="state==4&&join==true" class="coupon-quota textcenter">
                        <div class="coupon-box">
                            <div class="coupon-value">{{self.coupon}}</div>
                            <img class="img-coupon" :src="IMGPrefix+'/img/e_tailors_festival/coupon_slices.png'" alt="">
                        </div>
                    </section>
                    <section v-else class="coupon-quota textcenter">
                        <div class="coupon-box">
                            <div class="coupon-value">{{amount}}</div>
                            <img class="img-coupon" :src="IMGPrefix+'/img/e_tailors_festival/coupon_default.png'" alt="">
                        </div>
                    </section>
                </div>
                <div v-else>
                    <section class="coupon-quota textcenter">
                        <img class="img-coupon" :src="IMGPrefix+'/img/e_tailors_festival/coupon.png'" alt="">
                    </section>
                </div>
                
                <section class="coupon-title textcenter">
                    <!-- 活动截止 -->
                    <div v-if="config.valid===false">
                        <div class="coupon-title-main">很遗憾，活动结束！下次活动再接再厉哦</div>
                        <!-- <div class="coupon-title-endtime">{{config.openDate}}结束</div> -->
                    </div>
                    <!-- 拆券中 且 未成团或未参加 -->
                    <div v-else-if="config.valid==true&&config.isOpenDateEnd==false&&state<4">
                        <div class="coupon-title-main">未成团不遗憾，点击领取百元专享券</div>
                        <div class="coupon-title-endtime">{{config.openDate}}结束</div>
                    </div>
                    <template v-else>
                        <div v-if="state==1">
                            <div class="coupon-title-main">11.11五人团战省钱攻略</div>
                            <div class="coupon-title-subtitle">最高送550元半价券</div>
                        </div>
                        <div v-else-if="join==false">
                            <div class="coupon-title-main" v-if="state>=4">很遗憾，当前拼团人数已满</div>
                            <div class="coupon-title-main" v-else>您的小伙伴邀您走向省钱巅峰</div>
                            <div class="coupon-title-endtime">{{config.openDate}}结束</div>
                        </div>
                        <div v-else-if="state==2||state==3">
                            <div class="coupon-title-main">瓜分神券进行中</div>
                            <div class="coupon-title-endtime">{{config.openDate}}结束</div>
                        </div>
                        <div v-else-if="state==4">
                            <div class="coupon-title-main">小伙伴已就位，点击拆开</div>
                            <div class="coupon-title-endtime">{{config.openDate}}结束</div>
                        </div>
                        <div v-else-if="state==5">
                            <div class="coupon-title-endtime">优惠券已拆取成功！</div>
                        </div>
                    </template>
                </section>
                <section class="user-list" v-if="state==2||state==3||state==4">
                    <ul class="" flex="main:justify">
                        <li class="user-item" v-for="item in teamList" :key="'useritemreal'+item.id">
                            <div class="user-headimg real" flex="main:center cross:center">
                                <img :src="item.avatarUrl || (IMGPrefix+'/img/e_tailors_festival/default_avatar.jpg')" width="100%" alt="">
                            </div>
                            <div v-if="item.role==1" class="user-name textcenter">团长</div>
                        </li>
                        <li class="user-item" v-for="i in 5-teamList.length" :key="'useritemempty'+i">
                            <div class="user-headimg empty" flex="main:center cross:center">
                                <span class="user-headimg-text">?</span>
                            </div>
                        </li>
                    </ul>
                </section>
                <template v-if="state&&state!=5">
                    <section class="coupon-progress">
                        <ul flex="cross:corsss">
                            <li v-for="item in stepList" :key="'stepitemline'+item.id" :flex-box="item.portion" flex="cross:center" class="coupon-item" :class="{'reach': item.key<state, 'current': item.key==state||(item.key==4&&state==5)}">
                                <div class="progress-line-box" flex-box="1" flex="cross:center">
                                    <hr flex-box="1" class="progress-line progress-line-rea">
                                    <div class="progress-line-center" flex="main:center cross:center">
                                        <div class="progress-line-center-point"></div>
                                    </div>
                                    <hr flex-box="1" class="progress-line" :class="{'progress-line-rea': item.key==4}">
                                </div>
                            </li>
                        </ul>
                        <ul flex="cross:top">
                            <li v-for="item in stepList" :key="'stepitemname'+item.id" class="coupon-item" :class="{'reach': item.key<state, 'current': item.key==state||(item.key==4&&state==5)}" :flex-box="item.portion">
                                <div class="progress-name textcenter">
                                    <div>{{item.name}}</div>
                                    <div v-if="item.name2">{{item.name2}}</div>
                                </div>
                            </li>
                        </ul>
                    </section>
                    <summary class="summary">
                        <div class="summary-title" flex="cross:center">
                            <div flex-box="1"><hr class="summary-title-line"></div>
                            <div class="summary-title-word">规则描述</div>
                            <div flex-box="1"><hr class="summary-title-line"></div>
                        </div>
                        <div class="summary-content">
                            <p class="summary-content-p">1. 组团拼手气拆券，开团后成员可邀请好友参与。</p>
                            <p class="summary-content-p">2. 拼团成功：限定日期内，组成五人团，即可瓜分总面值1000元的Yeelight京东优惠券。</p>
                            <p class="summary-content-p">3. 拼团失败：限定时间内未组成五人团，即视为拼团失败，仍可获得超值券。</p>
                            <p class="summary-content-p">4. 优惠券发放：拼团成功后将于11月9日统一拆券，届时请点击立即拆券，并至京东平台使用。</p>
                            <p class="summary-content-p">5. 团所拆优惠券分为全店满减券、限定品类满减券、指定商品39折券，指定商品半价券等超值优惠券。</p>
                            <p class="summary-content-p">6. 满减券仅限本人使用，不得转让、不兑换现金。</p>
                            <p class="summary-content-p">7. 活动最终解释权归Yeelight品牌所有。</p>
                        </div>
                    </summary>
                </template>
                
                <summary class="summary-fin" v-else-if="state==5">
                    <div class="summary-title" flex="cross:center">
                        <div flex-box="1"><hr class="summary-title-line"></div>
                        <div class="summary-title-word">看看小伙伴手气如何</div>
                        <div flex-box="1"><hr class="summary-title-line"></div>
                    </div>
                    <div class="summary-content">
                        <ul class="coupondis-list">
                            <li v-for="item in teamList" class="item-coupondis" :key="'usercouponitem'+item.id" flex="cross:center">
                                 <div class="user-item">
                                    <div class="user-headimg real" flex="main:center cross:center">
                                        <img :src="item.avatarUrl" width="100%" alt="">
                                    </div>
                                    <div v-if="item.role==1" class="user-name textcenter">团长</div>
                                </div>
                                <div class="jointeaminfo" flex-box="1">
                                    <div class="weixin-name">{{item.nickName}}</div>
                                    <div class="userjointime">{{formatTime(item.joinTime)}}</div>
                                </div>
                                <div class="item-coupon-value">{{item.coupon}}元</div>
                            </li>
                        </ul>
                    </div>
                </summary>
            </main>
            <footer class="footer visibility" >
                <img class="img-bg-bottom" :src="IMGPrefix+'/img/e_tailors_festival/bg-bottom.png'" alt="">
            </footer>
            <footer class="footer isOver">
                <img class="img-bg-bottom" :src="IMGPrefix+'/img/e_tailors_festival/bg-bottom.png'" alt="">
            </footer>
        </article>
        <template v-if="state && config.valid">
            <aside v-if="config.isOpenDateEnd==false&&(state<4||join==false)" class="aside textcenter">
                <button class="btn-aside btn-openteam" @click="handleBth">
                    <img :src="IMGPrefix+'/img/e_tailors_festival/logo.png'" alt="" width="19px"> 
                    <span class="btn-aside-text">立即领券</span>
                </button>
            </aside>
            <div v-else>
                <aside class="aside textcenter" v-if="state==1 || (join==false&&state<4) ">
                    <button class="btn-aside btn-openteam" @click="handleBth">
                        <img :src="IMGPrefix+'/img/e_tailors_festival/logo.png'" alt="" width="19px"> 
                        <span class="btn-aside-text">立即参团</span>
                    </button>
                </aside>
                <aside class="aside textcenter" v-else-if="state==2 || state==3">
                    <button class="btn-aside btn-openteam" @click="handleBth">
                        <img :src="IMGPrefix+'/img/e_tailors_festival/logo.png'" alt="" width="19px"> 
                        <span class="btn-aside-text">呼唤小伙伴</span>
                    </button>
                </aside>
                <aside v-else-if="state==4 && join" class="aside textcenter">
                    <button class="btn-aside btn-openteam" @click="handleBth">
                        <img :src="IMGPrefix+'/img/e_tailors_festival/logo.png'" alt="" width="19px"> 
                        <span class="btn-aside-text">立即拆券</span>
                    </button>
                </aside>
            </div>
        </template> 
        <div class="mask" v-show="maskFlag" @click="maskFlag=false">
            <div class="mask-img">
                <img class="img-jiantou" :src="IMGPrefix+'/img/e_tailors_festival/jiantou.png'" alt="">
            </div>
            <div class="mask-word">
                <div class="mask-word-con">点击 "转发" 邀请好友</div>
            </div>
        </div>
    </div>
</template>

<script>
    import { getQueryString, validatenull } from '@/util/util';
    import { getToken2, setToken2 } from '@/util/auth'
    import { getteam, jointeam, opencoupon, config, autoCookie, share, defaultCoupon } from '@/service/e_tailors_festival';
    export default {
        data(){
            return {
                config: {
                    valid: null,
                    isOpenDateEnd: null, //拆券是否截止
                    validDate: '',
                    openDate: '', 
                },
                amount: '',//默认优惠券
                amountUrl: '',
                state: 0, // 1.初始状态；2.团长开团；3.有小伙伴加入（不满5人）；4.已满团（满5人）;5.已开券
                role: 1, // 角色，1.团长；2.团员
                join: null, // 是否已加入
                // scene: '', // 来源
                teamId: '', // 团ID
                self: {}, //个人信息
                teamList: [],
                stepList: [{
                    id: 1,
                    name: '开团',
                    portion: 2,
                    key: 1
                }, {
                    id: 2,
                    name: '邀请好友',
                    name2: '团战',
                    portion: 3,
                    key: 2
                }, {
                    id: 3,
                    name: '限定日期',
                    name2: '满5人成团',
                    portion: 3,
                    key: 3
                }, {
                    id: 4,
                    name: '拆券并领取',
                    portion: 2,
                    key: 4
                }],
                // eslint-disable-next-line no-undef
                IMGPrefix: IMGPrefix,
                maskFlag: false,
            }
        },
        mounted(){
            let token =  getToken2();
            if(token) setToken2(token);
            this.teamId = getQueryString('teamId');

            this.init();
        },
        methods: {
            init(){
                config().then(res => {
                    // res.data.valid = false;
                    if(res.data){
                        this.config = res.data
                    }
                    // 活动未截止
                    if(this.config.valid){
                        this.vmGetteam();
                        //拆券中
                        if(!this.config.isOpenDateEnd) {
                            defaultCoupon().then(res => {
                                let data = res.data;
                                this.amount = data.amount;
                                this.amountUrl = data.url;
                            });
                        }
                    } else {//活动截止
                        this.state = 1; 
                    }
                }, rej => {
                    if(rej.status == '401') {
                        location.href = autoCookie(location.href);
                    }
                })
            },
            // 获取当前状态信息
            vmGetteam() {
                getteam(this.teamId).then(res => {
                    if(!validatenull(res.data)){
                        let data = res.data;
                        this.join = data.join;
                        if(this.join) {
                            this.self = data.self;
                            this.role = this.self.role;
                        }
                        if(validatenull(data.team)){
                            this.state = 1;
                            return;
                        }
                        this.teamList = data.team;
                        
                        this.teamId = this.teamList[0].teamId;
                        if(this.teamList.length == 1) {
                            this.state = 2;
                        } else if(this.teamList.length < 5) {
                            this.state = 3
                        } else if(this.self.openTime) {
                            this.state = 5;
                            return;
                        } else {
                            this.state = 4;
                        }
                        // history.replaceState('', "", '?teamId='+this.teamId);
                    }
                }, err => {
                    alert(err.data.msg);
                });
            },
            initMessage() {
                share(location.href).then(res => {
                    let json = res.data;
                    const shareObj = {
                        link: location.href+'?teamId=' + this.teamId,
                        imgUrl: this.IMGPrefix + '/img/e_tailors_festival/share_icon.png',
                    };
                    wx.config({
                        debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                        appId: json.appId, // 必填，公众号的唯一标识
                        timestamp:json.timestamp , // 必填，生成签名的时间戳
                        nonceStr: json.nonceStr, // 必填，生成签名的随机串
                        signature: json.signature,// 必填，签名
                        jsApiList: ['updateAppMessageShareData', 'updateTimelineShareData'] // 必填，需要使用的JS接口列表
                    });
                    wx.ready(function () {   //需在用户可能点击分享按钮前就先调用
                        // 自定义“分享给朋友”及“分享到QQ”按钮的分享内容
                        wx.updateAppMessageShareData({ 
                            title: '【智造光 易起来】11.11千元神券来袭！', // 分享标题
                            desc: '五人参团即可瓜分京东11.11千元大额券，立即参与吧！', // 分享描述
                            link: shareObj.link, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                            imgUrl: shareObj.imgUrl, // 分享图标
                            success: function () {
                            // 设置成功
                                console.log('朋友分享成功')
                            }
                        });
                        // 自定义“分享到朋友圈”及“分享到QQ空间”按钮的分享内容（
                        wx.updateTimelineShareData({ 
                            title: '【智造光 易起来】11.11千元神券来袭！', // 分享标题
                            link: shareObj.link, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                            imgUrl: shareObj.imgUrl, // 分享图标
                            success: function () {
                            // 设置成功
                                console.log('朋友圈分享成功')
                            }
                        })
                    });
                })
            },
            handleBth(){
                if(this.config.isOpenDateEnd==false) {
                    if(this.state<4 || this.join==false) {
                        location.href = this.amountUrl;
                    }else if(this.state==4 && this.join) {
                        location.href = this.self.couponsDetail.url;
                    }else {
                        return;
                    }
                    this.vmOpencoupon();
                }else {
                    if(this.state == 1) {
                        this.vmJointeam();
                    }else if(this.state == 4){
                        if(this.join == false){
                            alert('您不在当前团中，无法领取优惠券');
                            return;
                        }
                        if(this.config.isOpenDateEnd) {
                            alert('拆券时间2019年11月09日 - 2019年11月11日')
                            return;
                        }
                    } else {
                        if(this.join == false){
                            this.vmJointeam();
                        }else{
                            this.maskFlag = true;
                        }
                    }
                }
            },
            vmJointeam(){
                jointeam(this.teamId).then(res => {
                    if(!res.success){
                        alert(res.data.msg);
                    }
                    this.init();
                    location.href = location.origin + location.pathname + '?teamId='+this.teamId;
                    
                }).catch(err => {
                    alert(err.data.msg);
                    this.init();
                })
            },
            vmOpencoupon(){
                opencoupon().then(() => {
                    this.init();
                })
            },
            add0 (m){return m<10?'0'+m:m },
            formatTime(timestamp){
                let time = new Date(parseInt(timestamp)*1000);
                let m = time.getMonth()+1;
                let d = time.getDate();
                let h = time.getHours();
                let mm = time.getMinutes();
                let s = time.getSeconds();
                return this.add0(m)+'.'+this.add0(d)+' '+this.add0(h)+':'+this.add0(mm)+':'+this.add0(s);
            }
        }
    }
</script>

<style>
    body{
        background: #FAF5EC;
        font-family: -apple-system,Helvetica,sans-serif;
    }
</style>

<style lang="scss" scoped>
    .textcenter{
        text-align: center;
    }
</style>

<style lang="scss" scoped>
    $pageWidthMaxPx: 750px;
    $pageWidthMaxRem: 18.75rem;
    $mainFontColor: #333333;
    $userColor: #CEA460;
    $asideBtnHeight: 50px;
    .container{
        position: relative;
        max-width: $pageWidthMaxPx;
        margin: 0 auto;
        color: $mainFontColor;
        min-height: 100vh;
    }
    .content.hasAside{
        padding-bottom: $asideBtnHeight;
    }
    .header{
        position: relative;
    }
    .img-bg-header{
        width: 100%;
    }
    .bg-title{
        position: absolute;
        top: 2.025rem;
        width: 100%;
        .img-bg-title{
            width: 17rem;
        }
        .img-bg-title-2{
            width: 10.75rem;
        }
        .bg-title-word{
            margin-top: 1rem;
            font-size: 1rem;
            font-family:Alibaba-PuHuiTi-M;
            font-weight:500;
            color:rgba(255,255,255,1);
            line-height: 1;
        }
    }
    .main-coupon{
        padding: 2.525rem 2.125rem 0;
    }
    .img-coupon{
        width: 100%;
    }
    .coupon-box{
        position: relative;
    }
    .coupon-value{
        position: absolute;
        top: 2rem;
        left: 1.3rem;
        font-size: 3.75rem;
        font-weight:bold;
        color:rgba(255,255,255,1);
        font-family:MIUIEX-Bold;
        line-height: 1;
    }
    .coupon-title{
        margin-top: .9rem;
        line-height: 1;
        .coupon-title-main{
            font-size: .8rem;
            font-family: PingFangSC-Regular;
            color: rgba(155,73,73,1);
        }
        .coupon-title-endtime{
            margin-top: .625rem;
            font-size: .6rem;
            font-family:PingFangSC-Light;
            font-weight:300;
            color:rgba(102,102,102,1);
            line-height: 1;
            letter-spacing: .05rem;
        }
        .coupon-title-subtitle{
            margin-top: .625rem;
            font-size: .6rem;
            color:#4A4A4A;
            line-height: 1;
            letter-spacing: .05rem;
        }

    }

    .user-list{
        margin-top: 1.725rem;
    }
    .user-item{
        position: relative;
    }
    .user-headimg{
        width: 2.4rem;
        height: 2.4rem;
        border-radius: 50%;
        font-size: 1.25rem;
        color: $userColor;
        overflow: hidden;
        &.real{
            border: 1px solid $userColor;
        }
        &.empty{
            border: 1px dashed $userColor;
        }
    }
    .user-name{
        position: absolute;
        top: 100%;
        left: 50%;
        width: 1.95rem;
        height: 0.65rem;
        line-height: 0.65rem;
        margin-left: -.975rem;
        margin-top: -.325rem;
        border-radius: .325rem;
        color: #fff;
        background: $userColor;
        font-size: .55rem;

    }

    .coupon-progress{
        margin-top: 3rem;
    }
    .coupon-item{
        flex-basis: 0;
    }
    .progress-name{
        margin-top: .3rem;
        font-size: .55rem;
        line-height: .725rem;
    }
    .progress-line{
        margin: 0;
        border: none;
        border-top: 1px dashed #999999;
    }
   
    .progress-line-center-point{
        width: .3rem;
        height: .3rem;
        border-radius: 50%;
        background: #999999;
    }
    .reach{
        .progress-name{
            color: $userColor;
        }
        .progress-line{
            border-top: 1px solid $userColor;
        }
        .progress-line-center-point{
            background: $userColor;
        }
    }
    .current{
        .progress-name{
            color: $userColor;
        }
        .progress-line-center-point{
            background: $userColor;
        }
        .progress-line-rea{
            border-top: 1px solid $userColor;
        }
        .progress-line-center{
            width: 0.55rem;
            height: 0.55rem;
            border-radius: 50%;
            border: 1px solid $userColor;
        }
    }

    .summary{
        margin-top: 2.5rem;
    }
    .summary-fin{
        margin-top: 2.075rem;
    }
    .summary-title-line{
        margin: 0;
        border: none;
        border-top: 1px solid #CEA460;
    }
    .summary-title-word{
        margin: 0 .2rem;
        font-size: .65rem;
        font-family: PingFangSC-Regular;
        color:rgba(51,51,51,1);
        line-height: 1;
    }
    .summary-content{
        margin-top: 1.225rem;
        .summary-content-p{
            font-size: .6rem;
            font-family:PingFangSC-Light;
            font-weight:300;
            color:rgba(51,51,51,1);
            line-height: 1rem;
            // &+.summary-content-p{
                margin-top: .6rem;
            // }
        }
    }

    .coupondis-list{
        margin-top: 2rem;
    }
    .item-coupondis + .item-coupondis{
        margin-top: 1.65rem;
    }
    .jointeaminfo{
        padding: 0 1rem;
    }
    .weixin-name{
        font-size: .7rem;
        font-family: PingFangSC-Medium;
        font-weight: 500;
        color: rgba(51,51,51,1);
        line-height: 1;
    }
    .userjointime{
        margin-top: .5rem;
        font-size: .55rem;
        font-family: PingFangSC-Light;
        font-weight: 300;
        color: rgba(102,102,102,1);
        line-height: 1;
    }
    .item-coupon-value{
        font-size: .75rem;
        font-family: PingFangSC-Medium;
        font-weight: 500;
        color: rgba(51,51,51,1);
    }

    .img-bg-bottom{
        width: 100%;
    }

    .aside{
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding-bottom: env(safe-area-inset-bottom);
        background: #FAF5EC;
    }
    // @supports not(bottom: env(safe-area-inset-bottom)){
    //     .aside{
    //         bottom: 0;
    //     }
    // }
    .btn-aside{
        height: $asideBtnHeight;
        width: 100%;
        max-width: $pageWidthMaxPx;
        background: $userColor;
        color:rgba(255,255,255,1);
        line-height: 1;
        cursor: pointer;
        touch-action: manipulation;
        &:active{
            background: $userColor*.8;
        }
    }
    .btn-aside-text{
        vertical-align: middle; 
        margin-left: 10px;
        font-size: 16px;
        font-family:PingFangSC-Regular;
    }

    .mask{
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, .7);
    }
    .mask-img{
        text-align: right;
    }
    .img-jiantou{
        width: 5.275rem;
    }
    .mask-word{
        position: relative;
    }
    .mask-word-con{
        position: absolute;
        top: 0.525rem;
        right: 1.75rem;
        width: 10rem;
        line-height: 2.5rem;
        background: rgba(206,164,96,1);
        border-radius: 0.25rem;
        color: #fff;
        text-align: center;
        font-size: .9rem;
        font-family:PingFangSC-Regular;
    }
    .footer{
        padding-bottom: env(safe-area-inset-bottom);
    }
    .footer.isOver{
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
    }
    .hasAside{
        .footer.isOver{
            bottom: $asideBtnHeight;
        }
    }
    .footer.visibility{
        visibility: hidden;
    }
</style>